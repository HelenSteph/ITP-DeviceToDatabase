# IoT ThingPolicy CloudFormation
# 
# Run with the aws cli
#     aws cloudformation create-stack --template-body file://thing-policy.yaml --stack-name thing-policy
#
Resources:
  ThingPolicy:
    Type: 'AWS::IoT::Policy'
    Properties:
      PolicyName: ThingPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: 'iot:Connect'
            Resource:
              - !Sub 'arn:aws:iot:${AWS::Region}:${AWS::AccountId}:client/${!iot:Certificate.Subject.CommonName}'
          - Effect: Allow
            Action:
              - 'iot:Publish'
              - 'iot:Receive'
            Resource: 
              - !Sub 'arn:aws:iot:${AWS::Region}:${AWS::AccountId}:topic/things/${!iot:ClientId}/*'
          - Effect: Allow
            Action: 'iot:Subscribe'
            Resource: 
              - !Sub 'arn:aws:iot:${AWS::Region}:${AWS::AccountId}:topicfilter/things/${!iot:ClientId}/*'
